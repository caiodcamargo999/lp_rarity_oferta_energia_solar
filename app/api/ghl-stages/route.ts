import { NextResponse } from 'next/server'

export async function GET() {
  try {
    const apiKey = process.env.GHL_API_KEY
    const locationId = process.env.GHL_LOCATION_ID

    if (!apiKey || !locationId) {
      return NextResponse.json({
        success: false,
        message: 'GHL_API_KEY e GHL_LOCATION_ID s√£o obrigat√≥rios'
      }, { status: 400 })
    }

    console.log('üîç Buscando stages do pipeline padr√£o...')

    // Buscar stages do pipeline padr√£o (usando locationId como pipelineId)
    const stagesResponse = await fetch(
      `https://services.leadconnectorhq.com/opportunities/pipelines/${locationId}/stages`,
      {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${apiKey}`,
          'Content-Type': 'application/json',
          'Version': '2021-07-28'
        }
      }
    )

    const stagesData = await stagesResponse.json()

    if (!stagesResponse.ok) {
      throw new Error(`Erro na API: ${stagesData.message}`)
    }

    console.log('üìä Stages encontrados:', stagesData.stages?.length || 0)

    // Procurar pelo stage "Reuni√£o Agendada"
    const reuniaoAgendadaStage = stagesData.stages?.find((stage: any) => 
      stage.name.toLowerCase().includes('reuni√£o') || 
      stage.name.toLowerCase().includes('agendada') ||
      stage.name.toLowerCase().includes('reuniao')
    )

    return NextResponse.json({
      success: true,
      message: 'Stages do pipeline padr√£o obtidos com sucesso',
      data: {
        locationId,
        pipelineId: locationId, // Pipeline padr√£o usa o mesmo ID do location
        stages: stagesData.stages?.map((stage: any) => ({
          id: stage.id,
          name: stage.name,
          position: stage.position
        })) || [],
        reuniaoAgendadaStage: reuniaoAgendadaStage ? {
          id: reuniaoAgendadaStage.id,
          name: reuniaoAgendadaStage.name,
          position: reuniaoAgendadaStage.position
        } : null
      }
    })

  } catch (error) {
    console.error('‚ùå Erro ao buscar stages:', error)
    return NextResponse.json({
      success: false,
      message: error instanceof Error ? error.message : 'Erro desconhecido',
      timestamp: new Date().toISOString()
    }, { status: 500 })
  }
}
