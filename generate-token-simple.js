const { google } = require('googleapis');

// Configura√ß√£o OAuth2 mais simples
const oauth2Client = new google.auth.OAuth2(
  '384658893111-9a9ff4ik2173sl7jp53f85m4ia26vt50.apps.googleusercontent.com',
  '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',
  'urn:ietf:wg:oauth:2.0:oob' // URI especial para aplica√ß√µes desktop
);

// Escopos necess√°rios
const scopes = [
  'https://www.googleapis.com/auth/calendar',
  'https://www.googleapis.com/auth/calendar.events',
  'https://www.googleapis.com/auth/spreadsheets'
];

// Gerar URL de autoriza√ß√£o
const authUrl = oauth2Client.generateAuthUrl({
  access_type: 'offline',
  scope: scopes,
  prompt: 'consent'
});

console.log('üîó URL de Autoriza√ß√£o:');
console.log(authUrl);
console.log('\nüìã INSTRU√á√ïES ALTERNATIVAS:');
console.log('1. Copie a URL acima e cole no navegador');
console.log('2. Fa√ßa login com matheusdrarity@gmail.com');
console.log('3. Autorize todas as permiss√µes');
console.log('4. Voc√™ ser√° redirecionado para uma p√°gina com o c√≥digo');
console.log('5. Copie o c√≥digo e cole aqui\n');

// Interface para ler o c√≥digo
const readline = require('readline');
const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

rl.question('üìù Cole o c√≥digo de autoriza√ß√£o aqui: ', async (code) => {
  try {
    // Trocar c√≥digo por tokens
    const { tokens } = await oauth2Client.getToken(code);
    
    console.log('\nüéâ REFRESH TOKEN GERADO COM SUCESSO!');
    console.log('üìã Adicione isto ao seu .env.local:');
    console.log(`GOOGLE_OAUTH_REFRESH_TOKEN=${tokens.refresh_token}`);
    
    console.log('\nüîë Detalhes dos tokens:');
    console.log('Refresh Token:', tokens.refresh_token);
    console.log('Access Token:', tokens.access_token);
    console.log('Expires In:', tokens.expiry_date);
    
  } catch (error) {
    console.error('‚ùå Erro ao gerar refresh token:', error.message);
    console.log('\nüîß SOLU√á√ÉO ALTERNATIVA:');
    console.log('1. V√° para: https://script.google.com/');
    console.log('2. Fa√ßa login com matheusdrarity@gmail.com');
    console.log('3. Crie um novo projeto');
    console.log('4. Cole este c√≥digo e execute:');
    console.log(`
function getRefreshToken() {
  const clientId = '384658893111-9a9ff4ik2173sl7jp53f85m4ia26vt50.apps.googleusercontent.com';
  const clientSecret = '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';
  
  const url = 'https://accounts.google.com/o/oauth2/auth?' +
    'client_id=' + clientId +
    '&redirect_uri=urn:ietf:wg:oauth:2.0:oob' +
    '&scope=https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/spreadsheets' +
    '&response_type=code' +
    '&access_type=offline' +
    '&prompt=consent';
    
  Logger.log('URL de autoriza√ß√£o: ' + url);
  Logger.log('1. Cole esta URL no navegador');
  Logger.log('2. Fa√ßa login e autorize');
  Logger.log('3. Cole o c√≥digo aqui quando solicitado');
}
    `);
  } finally {
    rl.close();
  }
});
