// Script para upload de v√≠deo para Backblaze B2 (Alternativa mais est√°vel)
const fs = require('fs');
const path = require('path');

console.log('üöÄ UPLOAD PARA BACKBLAZE B2 - ALTERNATIVA MAIS EST√ÅVEL');
console.log('========================================================');

// ===== CONFIGURA√á√ÉO BACKBLAZE B2 =====
// ‚ö†Ô∏è IMPORTANTE: Configure suas credenciais do Backblaze B2
const B2_CONFIG = {
  endpoint: 'https://s3.us-west-002.backblazeb2.com', // Regi√£o US West
  accessKeyId: 'YOUR_B2_ACCESS_KEY_ID', // ‚ö†Ô∏è CONFIGURE AQUI
  secretAccessKey: 'YOUR_B2_SECRET_ACCESS_KEY', // ‚ö†Ô∏è CONFIGURE AQUI
  bucketName: 'YOUR_B2_BUCKET_NAME', // ‚ö†Ô∏è CONFIGURE AQUI
  region: 'us-west-002'
};

// Caminho do v√≠deo
const VIDEO_PATH = path.join(process.env.USERPROFILE || process.env.HOME, 'Downloads', 'video-de-vendas.mp4');

console.log('\nüìã CONFIGURA√á√ÉO NECESS√ÅRIA:');
console.log('1. Crie uma conta em: https://www.backblaze.com/b2/');
console.log('2. Crie um bucket p√∫blico');
console.log('3. Gere uma Application Key');
console.log('4. Configure as credenciais no script');

// Verificar se o arquivo existe
if (!fs.existsSync(VIDEO_PATH)) {
  console.error('‚ùå Arquivo n√£o encontrado!');
  console.log('üí° Verifique se o arquivo est√° em:', VIDEO_PATH);
  process.exit(1);
}

// Informa√ß√µes do arquivo
const stats = fs.statSync(VIDEO_PATH);
const fileSizeInMB = (stats.size / (1024 * 1024)).toFixed(2);

console.log('\nüìä INFORMA√á√ïES DO ARQUIVO:');
console.log('üìÅ Caminho:', VIDEO_PATH);
console.log('üìä Tamanho:', fileSizeInMB, 'MB');
console.log('üìÖ √öltima modifica√ß√£o:', stats.mtime);

// Verificar se as credenciais est√£o configuradas
if (B2_CONFIG.accessKeyId === 'YOUR_B2_ACCESS_KEY_ID') {
  console.log('\n‚ùå CREDENCIAIS N√ÉO CONFIGURADAS!');
  console.log('üí° Configure suas credenciais do Backblaze B2 no script');
  console.log('üîó Tutorial: https://help.backblaze.com/hc/en-us/articles/360047425453');
  process.exit(1);
}

async function uploadToB2() {
  try {
    const { S3Client, PutObjectCommand } = require('@aws-sdk/client-s3');
    
    console.log('\nüîß Configurando cliente Backblaze B2...');
    
    const client = new S3Client({
      region: B2_CONFIG.region,
      endpoint: B2_CONFIG.endpoint,
      credentials: {
        accessKeyId: B2_CONFIG.accessKeyId,
        secretAccessKey: B2_CONFIG.secretAccessKey,
      },
      forcePathStyle: true
    });

    const fileStream = fs.createReadStream(VIDEO_PATH);
    
    const command = new PutObjectCommand({
      Bucket: B2_CONFIG.bucketName,
      Key: 'video-de-vendas.mp4',
      Body: fileStream,
      ContentType: 'video/mp4',
      ACL: 'public-read'
    });

    console.log('üì§ Fazendo upload para Backblaze B2...');
    console.log('‚è±Ô∏è  Aguarde, arquivo grande sendo processado...');
    
    const result = await client.send(command);
    
    console.log('‚úÖ Upload conclu√≠do com sucesso!');
    console.log('üîó URL p√∫blica:', `${B2_CONFIG.endpoint}/${B2_CONFIG.bucketName}/video-de-vendas.mp4`);
    console.log('üìä ETag:', result.ETag);
    
    // ===== VERIFICAR ACESSO =====
    console.log('\nüîç Verificando acesso ao arquivo...');
    try {
      const testResponse = await fetch(`${B2_CONFIG.endpoint}/${B2_CONFIG.bucketName}/video-de-vendas.mp4`, {
        method: 'HEAD'
      });
      
      if (testResponse.ok) {
        console.log('‚úÖ Arquivo acess√≠vel publicamente!');
        console.log('üéâ Upload conclu√≠do com sucesso!');
        
        // ===== ATUALIZAR CONFIGURA√á√ÉO DO PROJETO =====
        console.log('\nüìù PR√ìXIMOS PASSOS:');
        console.log('1. Configure NEXT_PUBLIC_VIDEO_URL com a URL do B2');
        console.log('2. Fa√ßa deploy no Vercel');
        console.log('3. Teste o v√≠deo em produ√ß√£o');
        
      } else {
        console.log('‚ö†Ô∏è  Arquivo n√£o acess√≠vel publicamente. Status:', testResponse.status);
        console.log('üí° Configure o bucket como p√∫blico no dashboard do Backblaze B2');
      }
    } catch (testError) {
      console.log('‚ö†Ô∏è  N√£o foi poss√≠vel verificar acesso p√∫blico:', testError.message);
    }
    
  } catch (error) {
    console.error('‚ùå Erro no upload:', error.message);
    
    if (error.message.includes('AccessDenied')) {
      console.log('\nüîß SOLU√á√ÉO PARA ACESSO NEGADO:');
      console.log('1. Verifique se as credenciais est√£o corretas');
      console.log('2. Confirme se o bucket existe');
      console.log('3. Verifique permiss√µes da Application Key');
    }
  }
}

// Executar upload se credenciais estiverem configuradas
if (B2_CONFIG.accessKeyId !== 'YOUR_B2_ACCESS_KEY_ID') {
  try {
    require('@aws-sdk/client-s3');
    console.log('\n‚úÖ Depend√™ncias encontradas, iniciando upload...');
    uploadToB2();
  } catch (error) {
    console.log('\nüì¶ Depend√™ncias n√£o encontradas. Execute:');
    console.log('npm install @aws-sdk/client-s3 @aws-sdk/lib-storage');
  }
} else {
  console.log('\nüí° CONFIGURE SUAS CREDENCIAIS DO BACKBLAZE B2 NO SCRIPT');
}
