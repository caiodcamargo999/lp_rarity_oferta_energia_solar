// Script para upload usando APENAS o endpoint que funciona
const fs = require('fs');
const path = require('path');

console.log('üöÄ UPLOAD CLOUDFLARE R2 - ENDPOINT FUNCIONAL');
console.log('==============================================');

// ===== CONFIGURA√á√ÉO COM ENDPOINT FUNCIONAL =====
const R2_CONFIG = {
  // ===== ENDPOINT QUE FUNCIONA (Status 400 mas conecta!) =====
  endpoint: 'https://77f677cc90bcd810f75c80680f636a46.r2.cloudflarestorage.com',
  accessKeyId: '18d46aaf79c9700a7041bb9253f0efc4',
  secretAccessKey: '97ab4b36e10a7338ced2485465a01ddc81f2ab6d426925a09ab8e2ca272b228f',
  bucketName: 'vsl-solar-rarity-brasil',
  region: 'auto'
};

// Caminho do v√≠deo
const VIDEO_PATH = path.join(process.env.USERPROFILE || process.env.HOME, 'Downloads', 'video-de-vendas.mp4');

console.log('üìã CONFIGURA√á√ÉO:');
console.log('üìç Endpoint:', R2_CONFIG.endpoint);
console.log('ü™£ Bucket:', R2_CONFIG.bucketName);
console.log('üîë Access Key:', R2_CONFIG.accessKeyId);

// Verificar se o arquivo existe
if (!fs.existsSync(VIDEO_PATH)) {
  console.error('‚ùå Arquivo n√£o encontrado!');
  console.log('üí° Verifique se o arquivo est√° em:', VIDEO_PATH);
  process.exit(1);
}

// Informa√ß√µes do arquivo
const stats = fs.statSync(VIDEO_PATH);
const fileSizeInMB = (stats.size / (1024 * 1024)).toFixed(2);

console.log('\nüìä INFORMA√á√ïES DO ARQUIVO:');
console.log('üìÅ Caminho:', VIDEO_PATH);
console.log('üìä Tamanho:', fileSizeInMB, 'MB');

async function uploadToR2Working() {
  try {
    const { S3Client, PutObjectCommand, CreateBucketCommand, ListBucketsCommand } = require('@aws-sdk/client-s3');
    
    console.log('\nüîß Configurando cliente S3...');
    
    const client = new S3Client({
      region: R2_CONFIG.region,
      endpoint: R2_CONFIG.endpoint,
      credentials: {
        accessKeyId: R2_CONFIG.accessKeyId,
        secretAccessKey: R2_CONFIG.secretAccessKey,
      },
      forcePathStyle: true
    });

    // ===== VERIFICAR SE O BUCKET EXISTE =====
    console.log('üîç Verificando se o bucket existe...');
    try {
      const listCommand = new ListBucketsCommand({});
      const buckets = await client.send(listCommand);
      console.log('‚úÖ Buckets encontrados:', buckets.Buckets?.map(b => b.Name) || 'Nenhum');
      
      const bucketExists = buckets.Buckets?.some(b => b.Name === R2_CONFIG.bucketName);
      if (!bucketExists) {
        console.log('‚ö†Ô∏è  Bucket n√£o encontrado, tentando criar...');
        const createCommand = new CreateBucketCommand({
          Bucket: R2_CONFIG.bucketName
        });
        await client.send(createCommand);
        console.log('‚úÖ Bucket criado com sucesso!');
      } else {
        console.log('‚úÖ Bucket j√° existe!');
      }
    } catch (bucketError) {
      console.log('‚ö†Ô∏è  Erro ao verificar/criar bucket:', bucketError.message);
      console.log('üí° Continue mesmo assim...');
    }

    const fileStream = fs.createReadStream(VIDEO_PATH);
    
    const command = new PutObjectCommand({
      Bucket: R2_CONFIG.bucketName,
      Key: 'video-de-vendas.mp4',
      Body: fileStream,
      ContentType: 'video/mp4'
    });

    console.log('\nüì§ Fazendo upload...');
    console.log('‚è±Ô∏è  Aguarde, arquivo grande sendo processado...');
    
    const result = await client.send(command);
    
    console.log('‚úÖ Upload conclu√≠do com sucesso!');
    console.log('üîó URL p√∫blica:', `${R2_CONFIG.endpoint}/${R2_CONFIG.bucketName}/video-de-vendas.mp4`);
    console.log('üìä ETag:', result.ETag);
    
    // ===== VERIFICAR ACESSO =====
    console.log('\nüîç Verificando acesso ao arquivo...');
    try {
      const testResponse = await fetch(`${R2_CONFIG.endpoint}/${R2_CONFIG.bucketName}/video-de-vendas.mp4`, {
        method: 'HEAD'
      });
      
      if (testResponse.ok) {
        console.log('‚úÖ Arquivo acess√≠vel publicamente!');
        console.log('üéâ Upload conclu√≠do com sucesso!');
        
        // ===== ATUALIZAR CONFIGURA√á√ÉO =====
        console.log('\nüìù CONFIGURA√á√ÉO PARA O PROJETO:');
        console.log('NEXT_PUBLIC_VIDEO_URL=' + `${R2_CONFIG.endpoint}/${R2_CONFIG.bucketName}/video-de-vendas.mp4`);
        
      } else {
        console.log('‚ö†Ô∏è  Arquivo n√£o acess√≠vel publicamente. Status:', testResponse.status);
        console.log('üí° Configure o bucket como p√∫blico no dashboard do Cloudflare R2');
      }
    } catch (testError) {
      console.log('‚ö†Ô∏è  N√£o foi poss√≠vel verificar acesso p√∫blico:', testError.message);
    }
    
  } catch (error) {
    console.error('‚ùå Erro no upload:', error.message);
    
    // ===== DIAGN√ìSTICO ESPEC√çFICO =====
    if (error.message.includes('AccessDenied')) {
      console.log('\nüîß SOLU√á√ÉO PARA ACESSO NEGADO:');
      console.log('1. Verifique se as credenciais est√£o corretas');
      console.log('2. Confirme se o bucket foi criado');
      console.log('3. Verifique permiss√µes da API key no Cloudflare R2');
    } else if (error.message.includes('NoSuchBucket')) {
      console.log('\nüîß SOLU√á√ÉO PARA BUCKET N√ÉO ENCONTRADO:');
      console.log('1. Crie o bucket no dashboard do Cloudflare R2');
      console.log('2. Nome do bucket:', R2_CONFIG.bucketName);
      console.log('3. Configure como p√∫blico');
    } else if (error.message.includes('SSL') || error.message.includes('handshake')) {
      console.log('\nüîß PROBLEMA SSL RESOLVIDO!');
      console.log('‚úÖ Este endpoint funciona (Status 400 = conecta!)');
      console.log('üí° O problema √© configura√ß√£o do bucket/credenciais');
    }
  }
}

// Executar upload
try {
  require('@aws-sdk/client-s3');
  console.log('\n‚úÖ Depend√™ncias encontradas, iniciando upload...');
  uploadToR2Working();
} catch (error) {
  console.log('\nüì¶ Depend√™ncias n√£o encontradas. Execute:');
  console.log('npm install @aws-sdk/client-s3 @aws-sdk/lib-storage');
}
